<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠¶‰π†ËøõÂ∫¶ÊÄªËßà</title>
    <style>
        :root {
            --bg-color: transparent;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #37352f;
            --text-sub: #777;
            --accent: #2383e2;
            --success: #2ea043;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-round {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .card-round span {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: normal;
        }

        .mini-progress-track {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-top: auto;
        }

        .mini-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 3px;
        }

        .completed .mini-progress-fill {
            background: var(--success);
        }

        .status-text {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --card-bg: rgba(40, 40, 40, 0.9);
                --text-main: #fff;
                --text-sub: #aaa;
            }
        }

        /* Loading Mask */
        #loading-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 1);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        @media (prefers-color-scheme: dark) {
            #loading-mask {
                background: #1e1e1e;
            }
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-mask">
        <div class="spinner"></div>
    </div>
    <h1>üìö Â§ç‰π†ÂÖ®ÊôØÂõæ</h1>
    <div class="grid-container" id="card-grid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // === Firebase Config ===
        // TODO: ËØ∑Â°´ÂÖ•‰∏é todo/index.html Áõ∏ÂêåÁöÑÈÖçÁΩÆ (Please use the same config as todo/index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAyzdr7PnbRw5oyoXQN05JSAEEZFbxBI4Q",
            authDomain: "recite-flow-cloud.firebaseapp.com",
            projectId: "recite-flow-cloud",
            storageBucket: "recite-flow-cloud.firebasestorage.app",
            messagingSenderId: "782100544476",
            appId: "1:782100544476:web:08d5016464513f2d872d19",
            measurementId: "G-7MHQLT80LD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // === UI: Header & Auth ===
        const bodyTag = document.body;
        const headerDiv = document.createElement('div');
        headerDiv.style.width = '100%';
        headerDiv.style.maxWidth = '600px';
        headerDiv.style.display = 'flex';
        headerDiv.style.flexDirection = 'row';
        headerDiv.style.justifyContent = 'space-between';
        headerDiv.style.marginBottom = '15px';

        // --- Auth Form Container ---
        const authContainer = document.createElement('div');
        authContainer.id = 'auth-container';
        authContainer.style.display = 'flex';
        authContainer.style.gap = '8px';
        authContainer.style.alignItems = 'center';
        authContainer.style.background = '#f7f7f7'; // Lighter background
        authContainer.style.padding = '6px 12px';
        authContainer.style.borderRadius = '30px'; // Fully rounded container
        authContainer.style.boxShadow = '0 2px 6px rgba(0,0,0,0.05)';

        // Common Input Style
        const inputStyle = (input) => {
            input.style.padding = '6px 12px';
            input.style.borderRadius = '20px';
            input.style.border = '1px solid #e0e0e0';
            input.style.outline = 'none';
            input.style.fontSize = '13px';
            input.style.background = '#fff';
            input.style.transition = 'border-color 0.2s';
            input.onfocus = () => input.style.borderColor = '#2383e2';
            input.onblur = () => input.style.borderColor = '#e0e0e0';
        };

        // Inputs
        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.placeholder = 'ÈÇÆÁÆ±';
        inputStyle(emailInput);

        const passInput = document.createElement('input');
        passInput.type = 'password';
        passInput.placeholder = 'ÂØÜÁ†Å';
        inputStyle(passInput);

        // Common Button Style
        const btnStyle = (btn, primary = false) => {
            btn.style.padding = '6px 16px';
            btn.style.borderRadius = '20px';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '13px';
            btn.style.border = 'none';
            btn.style.transition = 'all 0.2s';

            if (primary) {
                btn.style.background = '#2383e2';
                btn.style.color = '#fff';
                btn.onmouseenter = () => btn.style.background = '#1a6cb8';
                btn.onmouseleave = () => btn.style.background = '#2383e2';
            } else {
                btn.style.background = '#fff';
                btn.style.color = '#555';
                btn.style.border = '1px solid #e0e0e0';
                btn.onmouseenter = () => {
                    btn.style.background = '#f5f5f5';
                    btn.style.borderColor = '#ccc';
                };
                btn.onmouseleave = () => {
                    btn.style.background = '#fff';
                    btn.style.borderColor = '#e0e0e0';
                };
            }
        };

        // Buttons
        const loginBtn = document.createElement('button');
        loginBtn.innerText = 'ÁôªÂΩï';
        btnStyle(loginBtn); // Secondary style

        const registerBtn = document.createElement('button');
        registerBtn.innerText = 'Ê≥®ÂÜå';
        btnStyle(registerBtn, true); // Primary style for Register to encourage it? Or maybe keep both plain?
        // Let's make "Login" primary actually, usually more common action.
        btnStyle(loginBtn, true);
        btnStyle(registerBtn, false);

        // Error Msg
        const errorMsg = document.createElement('div');
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '12px';
        errorMsg.style.marginTop = '5px';
        errorMsg.style.display = 'none';

        // Logged In State UI
        const userInfoSpan = document.createElement('span');
        userInfoSpan.style.marginRight = '10px';
        userInfoSpan.style.display = 'none';

        const logoutBtn = document.createElement('button');
        logoutBtn.innerText = 'ÈÄÄÂá∫';
        logoutBtn.style.display = 'none';
        logoutBtn.style.cursor = 'pointer';
        logoutBtn.style.padding = '4px 12px';
        logoutBtn.style.borderRadius = '20px';
        logoutBtn.style.border = '1px solid #ddd';
        logoutBtn.style.background = 'white';
        logoutBtn.style.color = '#555';
        logoutBtn.style.fontSize = '12px';
        logoutBtn.style.transition = 'all 0.2s';

        logoutBtn.onmouseenter = () => {
            logoutBtn.style.background = '#f5f5f5';
            logoutBtn.style.borderColor = '#ccc';
        };
        logoutBtn.onmouseleave = () => {
            logoutBtn.style.background = 'white';
            logoutBtn.style.borderColor = '#ddd';
        };

        // Add "New Subject" Button (Green one)
        const newSubjectBtn = document.createElement('button');
        newSubjectBtn.innerText = '+ Êñ∞Âª∫ÁßëÁõÆ';
        newSubjectBtn.style.padding = '8px 16px';
        newSubjectBtn.style.background = '#2ea043';
        newSubjectBtn.style.color = 'white';
        newSubjectBtn.style.border = 'none';
        newSubjectBtn.style.borderRadius = '6px';
        newSubjectBtn.style.cursor = 'pointer';
        newSubjectBtn.style.fontSize = '14px';
        newSubjectBtn.style.display = 'none'; // Hidden until login
        newSubjectBtn.style.alignSelf = 'flex-start'; // Left align this one independently if needed, or put in correct layout
        newSubjectBtn.style.marginBottom = '10px';

        // Assemble Header
        // We want New Subject on Left (or separate), Auth on Right.
        // Let's restructure headerDiv slightly to be a row.

        authContainer.appendChild(emailInput);
        authContainer.appendChild(passInput);
        authContainer.appendChild(loginBtn);
        authContainer.appendChild(registerBtn);

        const userContainer = document.createElement('div');
        userContainer.style.display = 'flex';
        userContainer.style.alignItems = 'center';
        userContainer.appendChild(userInfoSpan);
        userContainer.appendChild(logoutBtn);

        const rightSide = document.createElement('div');
        rightSide.style.display = 'flex';
        rightSide.style.flexDirection = 'column';
        rightSide.style.alignItems = 'flex-end';
        rightSide.appendChild(authContainer);
        rightSide.appendChild(userContainer); // Will only show one of these
        rightSide.appendChild(errorMsg);

        headerDiv.appendChild(newSubjectBtn);
        headerDiv.appendChild(rightSide);
        bodyTag.insertBefore(headerDiv, bodyTag.firstChild);

        const grid = document.getElementById('card-grid');

        let unsubscribeCollection = null;
        let currentUser = null;

        // === Auth Logic ===

        const showError = (msg) => {
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
            setTimeout(() => errorMsg.style.display = 'none', 5000);
        };

        loginBtn.onclick = () => {
            const email = emailInput.value;
            const pass = passInput.value;
            if (!email || !pass) return showError("ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å");

            signInWithEmailAndPassword(auth, email, pass)
                .then((cred) => {
                    console.log("Logged in:", cred.user.uid);
                    emailInput.value = '';
                    passInput.value = '';
                })
                .catch((error) => showError(error.message));
        };

        registerBtn.onclick = () => {
            const email = emailInput.value;
            const pass = passInput.value;
            if (!email || !pass) return showError("ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å");

            createUserWithEmailAndPassword(auth, email, pass)
                .then((cred) => {
                    console.log("Registered:", cred.user.uid);
                    emailInput.value = '';
                    passInput.value = '';
                })
                .catch((error) => showError(error.message));
        };

        logoutBtn.onclick = () => {
            signOut(auth).then(() => console.log("Logged out"));
        };

        // New Subject Logic
        newSubjectBtn.onclick = () => {
            const name = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁßëÁõÆÂêçÁß∞Ôºö");
            if (name && name.trim()) {
                const id = 'list_' + Date.now();
                // Redirect to create it
                window.open(`./todo/index.html?id=${id}&title=${encodeURIComponent(name)}`, '_blank');
            }
        };

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Show User UI
                authContainer.style.display = 'none';
                userContainer.style.display = 'flex';
                userInfoSpan.style.display = 'inline';
                userInfoSpan.innerText = user.email;
                logoutBtn.style.display = 'inline-block';

                newSubjectBtn.style.display = 'block';
                startCollectionListener();
            } else {
                // Show Login Form
                authContainer.style.display = 'flex';
                userContainer.style.display = 'none';

                newSubjectBtn.style.display = 'none';
                stopCollectionListener();
                grid.innerHTML = '<div style="text-align:center;width:100%;color:#999;font-size:14px;grid-column:1/-1;">ËØ∑ÁôªÂΩïÊàñÊ≥®ÂÜå‰ª•ÁÆ°ÁêÜÊÇ®ÁöÑÁßëÁõÆ</div>';

                // Not logged in -> We are ready to show UI (login form)
                hideLoadingMask();
            }
        });

        const loadingMask = document.getElementById('loading-mask');
        function hideLoadingMask() {
            if (loadingMask) {
                loadingMask.style.opacity = '0';
                setTimeout(() => loadingMask.style.display = 'none', 300);
            }
        }

        function stopCollectionListener() {
            if (unsubscribeCollection) {
                unsubscribeCollection();
                unsubscribeCollection = null;
            }
            grid.innerHTML = '';
        }

        function startCollectionListener() {
            stopCollectionListener();

            // Listen to the specific path where lists are stored
            // Path: /Users/wangyuchen/.gemini/antigravity/scratch/notion-clock/lists/
            const listsCollectionPath = `/Users/wangyuchen/.gemini/antigravity/scratch/notion-clock/lists`;
            const listsRef = collection(db, listsCollectionPath);

            grid.innerHTML = '<div style="text-align:center;width:100%;color:#999;font-size:14px;grid-column:1/-1;">Ê≠£Âú®Âä†ËΩΩ...</div>';

            unsubscribeCollection = onSnapshot(listsRef, (snapshot) => {
                grid.innerHTML = ''; // Clear current grid

                if (snapshot.empty) {
                    grid.innerHTML = '<div style="text-align:center;width:100%;color:#999;font-size:14px;grid-column:1/-1;">ÊöÇÊó†ÁßëÁõÆÔºåÁÇπÂáªÂ∑¶‰∏äËßíÊñ∞Âª∫</div>';
                    hideLoadingMask(); // Empty state also means we are loaded
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    const title = data.title || docId; // Fallback to ID if no title
                    const round = data.round || 0;

                    // Calc Progress
                    let percent = 0, total = 0, checked = 0;
                    if (data.listHtml) {
                        try {
                            const parser = new DOMParser();
                            const docDOM = parser.parseFromString(data.listHtml, 'text/html');
                            const checkboxes = docDOM.querySelectorAll('input[type="checkbox"]');
                            total = checkboxes.length;
                            checked = Array.from(checkboxes).filter(cb => cb.hasAttribute('checked') || cb.checked).length;
                            if (total > 0) percent = Math.round((checked / total) * 100);
                        } catch (e) { }
                    }

                    const isCompleted = (percent === 100 && total > 0);
                    const progressClass = isCompleted ? 'mini-progress-fill completed' : 'mini-progress-fill';

                    const cardLink = `./todo/index.html?id=${docId}&title=${encodeURIComponent(title)}`;

                    // Create UI
                    const card = document.createElement('div'); // Wrapper
                    card.style.position = 'relative'; // For delete btn positioning

                    // Content Link
                    const link = document.createElement('a');
                    link.className = 'card';
                    link.href = cardLink;
                    link.target = "_blank";
                    link.innerHTML = `
                        <div class="card-title">${title}</div>
                        <div class="card-round">${round} <span>ËΩÆ</span></div>
                        <div class="mini-progress-track">
                            <div class="${progressClass}" style="width: ${percent}%"></div>
                        </div>
                        <div class="status-text">
                            <span>ËøõÂ∫¶ ${percent}%</span>
                            <span>${checked}/${total}</span>
                        </div>
                    `;

                    // Delete Button
                    const delBtn = document.createElement('div');
                    delBtn.innerHTML = '√ó';
                    delBtn.style.position = 'absolute';
                    delBtn.style.top = '10px';
                    delBtn.style.right = '10px';
                    delBtn.style.width = '20px';
                    delBtn.style.height = '20px';
                    delBtn.style.background = 'rgba(0,0,0,0.1)';
                    delBtn.style.borderRadius = '50%';
                    delBtn.style.textAlign = 'center';
                    delBtn.style.lineHeight = '18px';
                    delBtn.style.fontSize = '14px';
                    delBtn.style.color = '#fff';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.opacity = '0'; // Hover only
                    delBtn.style.transition = 'opacity 0.2s';
                    delBtn.title = 'Âà†Èô§Ê≠§ÁßëÁõÆ';

                    delBtn.onclick = (e) => {
                        e.preventDefault();
                        if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‚Äú${title}‚ÄùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                            deleteDoc(doc(db, listsCollectionPath, docId))
                                .catch(err => alert("Âà†Èô§Â§±Ë¥•: " + err.message));
                        }
                    };

                    card.onmouseenter = () => delBtn.style.opacity = '1';
                    card.onmouseleave = () => delBtn.style.opacity = '0';

                    card.appendChild(link);
                    card.appendChild(delBtn);
                    grid.appendChild(card);
                });

                hideLoadingMask(); // Data loaded
            }, (error) => {
                console.error("Collection listener error:", error);
                grid.innerHTML = `<div style="text-align:center;width:100%;color:red;font-size:14px;grid-column:1/-1;">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
                hideLoadingMask(); // Error also means we stop loading
            });
        }

    </script>
</body>

</html>