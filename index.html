<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠¶‰π†ËøõÂ∫¶ÊÄªËßà</title>
    <style>
        :root {
            --bg-color: transparent;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #37352f;
            --text-sub: #777;
            --accent: #2383e2;
            --success: #2ea043;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Êñ∞Â¢ûÂ∏ÉÂ±ÄÊ†∑Âºè (Layout) --- */
        .dashboard-layout {
            display: flex;
            gap: 24px;
            width: 100%;
            max-width: 1000px;
            /* Ë∞ÉÂÆΩÈ°µÈù¢‰ª•ÂÆπÁ∫≥ÂèåÊ†è */
            align-items: flex-start;
            /* È°∂ÈÉ®ÂØπÈΩê */
        }

        .left-column {
            flex: 1;
            /* Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
            min-width: 0;
            /* Èò≤Ê≠¢ÂõæË°®ÊíëÁ†¥ÂÆπÂô® */
        }

        .right-column {
            width: 280px;
            /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ÂìçÂ∫îÂºèÔºöÊâãÊú∫Á´ØÂèòÂõûÂûÇÁõ¥Â†ÜÂè† */
        @media (max-width: 768px) {
            .dashboard-layout {
                flex-direction: column;
            }

            .left-column {
                width: 100%;
            }

            .right-column {
                width: 100%;
            }
        }

        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-round {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .card-round span {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: normal;
        }

        .mini-progress-track {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-top: auto;
        }

        .mini-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 3px;
        }

        .completed .mini-progress-fill {
            background: var(--success);
        }

        .status-text {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
        }

        /* --- Âè≥‰æßÂæÖÂäû‰∫ãÈ°πÊ†∑Âºè --- */
        .todo-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .todo-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .todo-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .todo-input {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .todo-input:focus {
            border-color: var(--accent);
        }

        .todo-add-btn {
            padding: 6px 10px;
            background: var(--text-main);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .todo-item:last-child {
            border-bottom: none;
        }

        .todo-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        .todo-text {
            flex: 1;
        }

        .todo-empty {
            text-align: center;
            color: #aaa;
            font-size: 12px;
            padding: 20px 0;
        }

        .todo-delete-btn {
            background: none;
            border: none;
            color: #ff4d4f;
            cursor: pointer;
            font-size: 16px;
            padding: 0 5px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-item:hover .todo-delete-btn {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --card-bg: rgba(40, 40, 40, 0.9);
                --text-main: #fff;
                --text-sub: #aaa;
            }

            .todo-input {
                background: #333;
                border-color: #555;
                color: white;
            }
        }

        /* Loading Mask */
        #loading-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 1);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        @media (prefers-color-scheme: dark) {
            #loading-mask {
                background: #1e1e1e;
            }
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="loading-mask">
        <div class="spinner"></div>
    </div>

    <div style="width: 100%; max-width: 1000px; margin-bottom: 20px; display: flex; align-items: center;">
        <h1 style="margin: 0;">üìö Â§ç‰π†ÂÖ®ÊôØÂõæ</h1>
        <span id="todo-badge"
            style="background: #eb5757; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; opacity: 0; transition: opacity 0.3s;">0</span>
    </div>

    <div class="dashboard-layout">
        <div class="left-column">
            <div id="chart-container"
                style="width: 100%; margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); box-sizing: border-box;">
                <canvas id="dailyStatsChart" style="height: 250px;"></canvas>
            </div>

            <div class="grid-container" id="card-grid"></div>
        </div>

        <div class="right-column">
            <div class="todo-card">
                <div class="todo-header">
                    üìù ‰ªäÊó•ÂæÖÂäû (To-Do)
                </div>
                <div class="todo-input-group">
                    <input type="text" class="todo-input" id="quick-todo-input" placeholder="Ê∑ªÂä†Êñ∞‰ªªÂä°...">
                    <button class="todo-add-btn" id="quick-todo-btn">+</button>
                </div>
                <ul class="todo-list" id="quick-todo-list">
                    <div class="todo-empty">ÊöÇÊó†ÂæÖÂäû</div>
                </ul>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";

        import {
            getFirestore,
            doc,
            collection,
            onSnapshot,
            deleteDoc,
            getDocs,
            addDoc,
            updateDoc,
            query,
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyAyzdr7PnbRw5oyoXQN05JSAEEZFbxBI4Q",
            authDomain: "recite-flow-cloud.firebaseapp.com",
            projectId: "recite-flow-cloud",
            storageBucket: "recite-flow-cloud.firebasestorage.app",
            messagingSenderId: "782100544476",
            appId: "1:782100544476:web:08d5016464513f2d872d19",
            measurementId: "G-7MHQLT80LD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // === UI: Header & Auth ===
        const bodyTag = document.body;
        const headerDiv = document.createElement('div');
        headerDiv.style.width = '100%';
        headerDiv.style.maxWidth = '1000px'; // Ë∞ÉÊï¥ÂÆΩÂ∫¶‰ª•ÂåπÈÖç dashboard-layout
        headerDiv.style.display = 'flex';
        headerDiv.style.flexDirection = 'row';
        headerDiv.style.justifyContent = 'space-between';
        headerDiv.style.marginBottom = '15px';

        // --- Auth Form Container ---
        const authContainer = document.createElement('div');
        authContainer.id = 'auth-container';
        authContainer.style.display = 'flex';
        authContainer.style.gap = '8px';
        authContainer.style.alignItems = 'center';
        authContainer.style.background = '#f7f7f7';
        authContainer.style.padding = '6px 12px';
        authContainer.style.borderRadius = '30px';
        authContainer.style.boxShadow = '0 2px 6px rgba(0,0,0,0.05)';

        // Common Input Style
        const inputStyle = (input) => {
            input.style.padding = '6px 12px';
            input.style.borderRadius = '20px';
            input.style.border = '1px solid #e0e0e0';
            input.style.outline = 'none';
            input.style.fontSize = '13px';
            input.style.background = '#fff';
            input.style.transition = 'border-color 0.2s';
            input.onfocus = () => input.style.borderColor = '#2383e2';
            input.onblur = () => input.style.borderColor = '#e0e0e0';
        };

        // Inputs
        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.placeholder = 'ÈÇÆÁÆ±';
        inputStyle(emailInput);

        const passInput = document.createElement('input');
        passInput.type = 'password';
        passInput.placeholder = 'ÂØÜÁ†Å';
        inputStyle(passInput);

        // Common Button Style
        const btnStyle = (btn, primary = false) => {
            btn.style.padding = '6px 16px';
            btn.style.borderRadius = '20px';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '13px';
            btn.style.border = 'none';
            btn.style.transition = 'all 0.2s';

            if (primary) {
                btn.style.background = '#2383e2';
                btn.style.color = '#fff';
                btn.onmouseenter = () => btn.style.background = '#1a6cb8';
                btn.onmouseleave = () => btn.style.background = '#2383e2';
            } else {
                btn.style.background = '#fff';
                btn.style.color = '#555';
                btn.style.border = '1px solid #e0e0e0';

                btn.onmouseenter = () => {
                    btn.style.background = '#f5f5f5';
                    btn.style.borderColor = '#ccc';
                };
                btn.onmouseleave = () => {
                    btn.style.background = '#fff';
                    btn.style.borderColor = '#e0e0e0';
                };
            }
        };

        // Buttons
        const loginBtn = document.createElement('button');
        loginBtn.innerText = 'ÁôªÂΩï';
        btnStyle(loginBtn, true);

        const registerBtn = document.createElement('button');
        registerBtn.innerText = 'Ê≥®ÂÜå';
        btnStyle(registerBtn, false);

        // Error Msg
        const errorMsg = document.createElement('div');
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '12px';
        errorMsg.style.marginTop = '5px';
        errorMsg.style.display = 'none';

        // Logged In State UI
        const userInfoSpan = document.createElement('span');
        userInfoSpan.style.marginRight = '10px';
        userInfoSpan.style.display = 'none';

        const logoutBtn = document.createElement('button');
        logoutBtn.innerText = 'ÈÄÄÂá∫';
        logoutBtn.style.display = 'none';
        logoutBtn.style.cursor = 'pointer';
        logoutBtn.style.padding = '4px 12px';
        logoutBtn.style.borderRadius = '20px';
        logoutBtn.style.border = '1px solid #ddd';
        logoutBtn.style.background = 'white';
        logoutBtn.style.color = '#555';
        logoutBtn.style.fontSize = '12px';
        logoutBtn.style.transition = 'all 0.2s';

        logoutBtn.onmouseenter = () => {
            logoutBtn.style.background = '#f5f5f5';
            logoutBtn.style.borderColor = '#ccc';
        };
        logoutBtn.onmouseleave = () => {
            logoutBtn.style.background = 'white';
            logoutBtn.style.borderColor = '#ddd';
        };

        // Add "New Subject" Button
        const newSubjectBtn = document.createElement('button');
        newSubjectBtn.innerText = '+ Êñ∞Âª∫ÁßëÁõÆ';
        newSubjectBtn.style.padding = '8px 16px';
        newSubjectBtn.style.background = '#2ea043';
        newSubjectBtn.style.color = 'white';
        newSubjectBtn.style.border = 'none';
        newSubjectBtn.style.borderRadius = '6px';
        newSubjectBtn.style.cursor = 'pointer';
        newSubjectBtn.style.fontSize = '14px';
        newSubjectBtn.style.display = 'none';
        newSubjectBtn.style.alignSelf = 'flex-start';
        newSubjectBtn.style.marginBottom = '10px';

        authContainer.appendChild(emailInput);
        authContainer.appendChild(passInput);
        authContainer.appendChild(loginBtn);
        authContainer.appendChild(registerBtn);

        const userContainer = document.createElement('div');
        userContainer.style.display = 'flex';
        userContainer.style.alignItems = 'center';
        userContainer.appendChild(userInfoSpan);
        userContainer.appendChild(logoutBtn);

        const rightSide = document.createElement('div');
        rightSide.style.display = 'flex';
        rightSide.style.flexDirection = 'column';
        rightSide.style.alignItems = 'flex-end';
        rightSide.appendChild(authContainer);
        rightSide.appendChild(userContainer);
        rightSide.appendChild(errorMsg);

        headerDiv.appendChild(newSubjectBtn);
        headerDiv.appendChild(rightSide);
        bodyTag.insertBefore(headerDiv, bodyTag.firstChild);

        const grid = document.getElementById('card-grid');

        let unsubscribeCollection = null;
        let currentUser = null;

        // === Auth Logic ===
        const showError = (msg) => {
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
            setTimeout(() => errorMsg.style.display = 'none', 5000);
        };

        loginBtn.onclick = () => {
            const email = emailInput.value;
            const pass = passInput.value;
            if (!email || !pass) return showError("ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å");

            signInWithEmailAndPassword(auth, email, pass).then((cred) => {
                console.log("Logged in:", cred.user.uid);
                emailInput.value = '';
                passInput.value = '';
            }).catch((error) => showError(error.message));
        };

        registerBtn.onclick = () => {
            const email = emailInput.value;
            const pass = passInput.value;
            if (!email || !pass) return showError("ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å");

            createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
                console.log("Registered:", cred.user.uid);
                emailInput.value = '';
                passInput.value = '';
            }).catch((error) => showError(error.message));
        };

        logoutBtn.onclick = () => {
            signOut(auth).then(() => console.log("Logged out"));
        };

        // New Subject Logic
        const modal = document.getElementById('new-subject-modal');
        const modalInput = document.getElementById('new-subject-input');
        const cancelBtn = document.getElementById('cancel-subject-btn');
        const confirmBtn = document.getElementById('confirm-subject-btn');

        newSubjectBtn.onclick = () => {
            modal.style.display = 'flex';
            modalInput.value = ''; // Reset
            modalInput.focus();
        };

        const createSubject = () => {
            const name = modalInput.value;
            if (name && name.trim()) {
                const id = 'list_' + Date.now();
                window.open(`./todo/index.html?id=${id}&title=${encodeURIComponent(name)}`, '_blank');
                modal.style.display = 'none';
            } else {
                alert("ËØ∑ËæìÂÖ•ÁßëÁõÆÂêçÁß∞");
            }
        };

        confirmBtn.onclick = createSubject;
        modalInput.onkeyup = (e) => {
            if (e.key === 'Enter') createSubject();
        };
        cancelBtn.onclick = () => {
            modal.style.display = 'none';
        };
        modal.onclick = (e) => {
            if (e.target === modal) modal.style.display = 'none';
        };

        // === Todo Real Logic ===
        const todoInput = document.getElementById('quick-todo-input');
        const todoAddBtn = document.getElementById('quick-todo-btn');
        const todoList = document.getElementById('quick-todo-list');
        let todoUnsubscribe = null;

        const renderTodos = (snapshot) => {
            todoList.innerHTML = '';
            if (snapshot.empty) {
                todoList.innerHTML = '<div class="todo-empty">ÊöÇÊó†ÂæÖÂäû</div>';
                return;
            }
            snapshot.forEach(docSnap => {
                const item = docSnap.data();
                const li = document.createElement('li');
                li.className = 'todo-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'todo-checkbox';
                checkbox.checked = item.done || false;
                checkbox.onclick = () => {
                    updateDoc(doc(db, `users/${currentUser.uid}/daily_todos`, docSnap.id), {
                        done: checkbox.checked
                    });
                };

                const span = document.createElement('span');
                span.className = 'todo-text';
                span.innerText = item.text;
                if (item.done) {
                    span.style.textDecoration = 'line-through';
                    span.style.color = '#999';
                }

                // Add delete on double click
                li.ondblclick = () => {
                    if (confirm('Âà†Èô§Ê≠§ÂæÖÂäûÔºü')) {
                        deleteDoc(doc(db, `users/${currentUser.uid}/daily_todos`, docSnap.id));
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'todo-delete-btn';
                deleteBtn.innerHTML = '&times;'; // Multiplication sign as X
                deleteBtn.title = 'Âà†Èô§';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Âà†Èô§Ê≠§ÂæÖÂäûÔºü')) {
                        deleteDoc(doc(db, `users/${currentUser.uid}/daily_todos`, docSnap.id));
                    }
                };

                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(deleteBtn);
                todoList.appendChild(li);
            });
        };

        const setupTodoListener = (uid) => {
            if (todoUnsubscribe) todoUnsubscribe();
            const todosRef = collection(db, `users/${uid}/daily_todos`);
            const q = query(todosRef, orderBy('createdAt', 'desc'));

            todoUnsubscribe = onSnapshot(q, (snapshot) => {
                renderTodos(snapshot);
            });
        };

        const addTodo = async () => {
            const text = todoInput.value.trim();
            if (!text || !currentUser) return;

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/daily_todos`), {
                    text: text,
                    done: false,
                    createdAt: Date.now()
                });
                todoInput.value = '';
            } catch (e) {
                console.error("Error adding todo:", e);
                alert("Ê∑ªÂä†Â§±Ë¥•");
            }
        };

        todoAddBtn.onclick = addTodo;
        todoInput.onkeyup = (e) => {
            if (e.key === 'Enter') addTodo();
        };

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const chartContainer = document.getElementById('chart-container');
            const dashboardLayout = document.querySelector('.dashboard-layout');

            if (user) {
                // Show User UI
                authContainer.style.display = 'none';
                userContainer.style.display = 'flex';
                userInfoSpan.style.display = 'inline';
                userInfoSpan.innerText = user.email;
                logoutBtn.style.display = 'inline-block';

                // Show Content
                if (dashboardLayout) dashboardLayout.style.display = 'flex';

                authContainer.style.position = 'static';
                authContainer.style.transform = 'none';
                authContainer.style.flexDirection = 'row';
                authContainer.style.width = 'auto';
                authContainer.style.height = 'auto';
                authContainer.style.boxShadow = '0 2px 6px rgba(0,0,0,0.05)';
                authContainer.style.background = '#f7f7f7';

                newSubjectBtn.style.display = 'block';
                newSubjectBtn.style.display = 'block';
                startCollectionListener();
                setupTodoListener(user.uid);
            } else {
                // Show Login Form (Centered)
                authContainer.style.display = 'flex';
                authContainer.style.position = 'fixed';
                authContainer.style.top = '50%';
                authContainer.style.left = '50%';
                authContainer.style.transform = 'translate(-50%, -50%)';
                authContainer.style.flexDirection = 'column';
                authContainer.style.gap = '15px';
                authContainer.style.padding = '40px';
                authContainer.style.borderRadius = '16px';
                authContainer.style.background = 'rgba(255,255,255,0.95)';
                authContainer.style.boxShadow = '0 10px 40px rgba(0,0,0,0.1)';
                authContainer.style.zIndex = '1000';
                authContainer.style.width = '300px';

                emailInput.style.width = '100%';
                passInput.style.width = '100%';
                loginBtn.style.width = '100%';
                registerBtn.style.width = '100%';

                userContainer.style.display = 'none';

                // Hide Content when not logged in
                if (dashboardLayout) dashboardLayout.style.display = 'none';

                newSubjectBtn.style.display = 'none';
                newSubjectBtn.style.display = 'none';
                if (todoUnsubscribe) todoUnsubscribe();
                todoList.innerHTML = '<div class="todo-empty">ÊöÇÊó†ÂæÖÂäû</div>'; // Clear todos on logout
                stopCollectionListener();
                grid.innerHTML = '';

                hideLoadingMask();
            }
        });

        const loadingMask = document.getElementById('loading-mask');
        function hideLoadingMask() {
            if (loadingMask) {
                loadingMask.style.opacity = '0';
                setTimeout(() => loadingMask.style.display = 'none', 300);
            }
        }

        function stopCollectionListener() {
            if (unsubscribeCollection) {
                unsubscribeCollection();
                unsubscribeCollection = null;
            }
            grid.innerHTML = '';

            // Reset Badge
            const badge = document.getElementById('todo-badge');
            if (badge) {
                badge.innerText = '0';
                badge.style.opacity = '0';
            }
        }

        function startCollectionListener() {
            stopCollectionListener();
            if (!currentUser) return;
            const listsCollectionPath = `users/${currentUser.uid}/lists`;
            const listsRef = collection(db, listsCollectionPath);

            grid.innerHTML = '<div style="text-align:center;width:100%;color:#999;font-size:14px;grid-column:1/-1;">Ê≠£Âú®Âä†ËΩΩ...</div>';

            unsubscribeCollection = onSnapshot(listsRef, (snapshot) => {
                grid.innerHTML = '';
                if (snapshot.empty) {
                    grid.innerHTML = '<div style="text-align:center;width:100%;color:#999;font-size:14px;grid-column:1/-1;">ÊöÇÊó†ÁßëÁõÆÔºåÁÇπÂáªÂ∑¶‰∏äËßíÊñ∞Âª∫</div>';
                    hideLoadingMask();
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    const title = data.title || docId;
                    const round = data.round || 0;

                    // Calc Progress
                    let percent = 0, total = 0, checked = 0;
                    if (data.listHtml) {
                        try {
                            const parser = new DOMParser();
                            const docDOM = parser.parseFromString(data.listHtml, 'text/html');
                            const checkboxes = docDOM.querySelectorAll('input[type="checkbox"]');
                            total = checkboxes.length;
                            checked = Array.from(checkboxes).filter(cb => cb.hasAttribute('checked') || cb.checked).length;
                            if (total > 0) percent = Math.round((checked / total) * 100);
                        } catch (e) { }
                    }

                    const isCompleted = (percent === 100 && total > 0);
                    const progressClass = isCompleted ? 'mini-progress-fill completed' : 'mini-progress-fill';
                    const cardLink = `./todo/index.html?id=${docId}&title=${encodeURIComponent(title)}`;

                    // Create UI
                    const card = document.createElement('div');
                    card.style.position = 'relative';

                    const link = document.createElement('a');
                    link.className = 'card';
                    link.href = cardLink;
                    link.target = "_blank";
                    link.innerHTML = `
                        <div class="card-title">${title}</div>
                        <div class="card-round">${round} <span>ËΩÆ</span></div>
                        <div class="mini-progress-track">
                            <div class="${progressClass}" style="width: ${percent}%"></div>
                        </div>
                        <div class="status-text">
                            <span>ËøõÂ∫¶ ${percent}%</span>
                            <span>${checked}/${total}</span>
                        </div>
                    `;

                    const delBtn = document.createElement('div');
                    delBtn.innerHTML = '√ó';
                    delBtn.style.position = 'absolute';
                    delBtn.style.top = '10px';
                    delBtn.style.right = '10px';
                    delBtn.style.width = '20px';
                    delBtn.style.height = '20px';
                    delBtn.style.background = 'rgba(0,0,0,0.1)';
                    delBtn.style.borderRadius = '50%';
                    delBtn.style.textAlign = 'center';
                    delBtn.style.lineHeight = '18px';
                    delBtn.style.fontSize = '14px';
                    delBtn.style.color = '#fff';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.opacity = '0';
                    delBtn.style.transition = 'opacity 0.2s';
                    delBtn.title = 'Âà†Èô§Ê≠§ÁßëÁõÆ';

                    delBtn.onclick = (e) => {
                        e.preventDefault();
                        if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‚Äú${title}‚ÄùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                            deleteDoc(doc(db, listsCollectionPath, docId)).catch(err => alert("Âà†Èô§Â§±Ë¥•: " + err.message));
                        }
                    };

                    card.onmouseenter = () => delBtn.style.opacity = '1';
                    card.onmouseleave = () => delBtn.style.opacity = '0';

                    card.appendChild(link);
                    card.appendChild(delBtn);
                    grid.appendChild(card);
                });

                // Update Total Badge
                let totalUnfinished = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.listHtml) {
                        const parser = new DOMParser();
                        const docDOM = parser.parseFromString(data.listHtml, 'text/html');
                        const checkboxes = docDOM.querySelectorAll('input[type="checkbox"]');
                        const checked = docDOM.querySelectorAll('input[type="checkbox"][checked]').length;
                        totalUnfinished += (checkboxes.length - checked);
                    }
                });

                const badge = document.getElementById('todo-badge');
                if (badge) {
                    badge.innerText = `${totalUnfinished} ÂæÖÂäû`;
                    badge.style.opacity = totalUnfinished > 0 ? '1' : '0';
                    badge.style.background = totalUnfinished > 0 ? '#eb5757' : 'transparent';
                }

                calculateDailyStats(snapshot);
                hideLoadingMask();
            }, (error) => {
                console.error("Collection listener error:", error);
                grid.innerHTML = `<div style="text-align:center;width:100%;color:red;font-size:14px;grid-column:1/-1;" >Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
                hideLoadingMask();
            });
        }

        let myChart = null;
        function calculateDailyStats(snapshot) {
            const stats = {};
            const subjects = new Set();
            const today = new Date();
            const dateLabels = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                stats[dateStr] = {};
                dateLabels.push(dateStr);
            }

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const title = data.title || docSnap.id;
                subjects.add(title);

                // ‰ºòÂÖà‰ΩøÁî®ÊåÅ‰πÖÂåñÁöÑ dailyStats
                if (data.dailyStats) {
                    Object.keys(data.dailyStats).forEach(dateStr => {
                        if (stats[dateStr]) {
                            if (!stats[dateStr][title]) stats[dateStr][title] = 0;
                            stats[dateStr][title] += data.dailyStats[dateStr];
                        }
                    });
                }
                // Fallback: Â¶ÇÊûúÊ≤°Êúâ dailyStatsÔºåÂ∞ùËØï‰ªé HTML Ëß£Êûê (ÂÖºÂÆπÊóßÊï∞ÊçÆ)
                else if (data.listHtml) {
                    try {
                        const parser = new DOMParser();
                        const docDOM = parser.parseFromString(data.listHtml, 'text/html');
                        const checkedItems = docDOM.querySelectorAll('input[type="checkbox"][checked][data-timestamp]');
                        checkedItems.forEach(item => {
                            const ts = parseInt(item.getAttribute('data-timestamp'));
                            if (!isNaN(ts)) {
                                const itemDate = new Date(ts).toISOString().split('T')[0];
                                if (stats[itemDate]) {
                                    if (!stats[itemDate][title]) stats[itemDate][title] = 0;
                                    stats[itemDate][title]++;
                                }
                            }
                        });
                    } catch (e) { }
                }
            });
            renderChart(dateLabels, Array.from(subjects), stats);
        }

        function renderChart(dates, subjects, statsData) {
            const ctx = document.getElementById('dailyStatsChart');
            if (ctx) {
                const palette = ['#2383e2', '#2ea043', '#db61a2', '#d9730d', '#9065b0', '#0d9488', '#e03e3e', '#57606a'];
                const datasets = subjects.map((subject, index) => {
                    const data = dates.map(date => (statsData[date] && statsData[date][subject]) ? statsData[date][subject] : 0);
                    const color = palette[index % palette.length];
                    return {
                        label: subject,
                        data: data,
                        backgroundColor: color,
                        borderRadius: 3,
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    };
                });

                const chartConfig = {
                    type: 'bar',
                    data: { labels: dates, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 15, font: { family: "-apple-system, sans-serif", size: 11 }, color: '#666' } },
                            title: { display: true, text: 'Ëøë 7 Â§©ËÉåËØµÁªüËÆ°', padding: { bottom: 20 }, font: { family: "-apple-system, sans-serif", size: 14, weight: 'normal' }, color: '#333' },
                            tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#333', bodyColor: '#666', borderColor: 'rgba(0,0,0,0.05)', borderWidth: 1, padding: 10, boxPadding: 4, usePointStyle: true }
                        },
                        scales: {
                            x: { stacked: true, grid: { display: false, drawBorder: false }, ticks: { color: '#999', font: { size: 10 }, maxRotation: 0, autoSkip: true }, border: { display: false } },
                            y: { stacked: true, beginAtZero: true, grid: { color: '#f0f0f0', drawBorder: false, borderDash: [4, 4] }, ticks: { stepSize: 1, color: '#ccc', font: { size: 10 }, padding: 10 }, border: { display: false } }
                        }
                    }
                };
                if (myChart) myChart.destroy();
                myChart = new Chart(ctx, chartConfig);
            }
        }
    </script>

    <div id="new-subject-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div
            style="background: white; padding: 25px; border-radius: 12px; width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <h3 style="margin-top: 0; margin-bottom: 15px; text-align: center;">Êñ∞Âª∫ÁßëÁõÆ</h3>
            <input type="text" id="new-subject-input" placeholder="ËØ∑ËæìÂÖ•ÁßëÁõÆÂêçÁß∞"
                style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between;">
                <button id="cancel-subject-btn"
                    style="flex: 1; margin-right: 10px; padding: 10px; border: none; background: #f0f0f0; border-radius: 6px; cursor: pointer; color: #666;">ÂèñÊ∂à</button>
                <button id="confirm-subject-btn"
                    style="flex: 1; padding: 10px; border: none; background: #2ea043; border-radius: 6px; cursor: pointer; color: white; font-weight: bold;">ÂàõÂª∫</button>
            </div>
        </div>
    </div>
</body>

</html>